<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Background Changer (MODNet)</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .hidden { display: none; }
    .btn-bar { display: flex; gap: 10px; margin-top: 10px; }
    video { border-radius: 6px; border: 1px solid #ccc; }
    .option-select { display: flex; gap: 16px; margin-bottom: 10px; }
    .btn-primary { background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .btn-secondary { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .btn-success { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    .tab-toggle {
  display: flex;
  border: 2px solid #ccc;
  border-radius: 6px;
  overflow: hidden;
  width: fit-content;
  font-family: sans-serif;
}

.tab-toggle input[type="radio"] {
  display: none;
}

.tab-toggle .tab {
  padding: 10px 20px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  border-right: 2px solid #ccc;
  background-color: #fff;
  color: #333;
  transition: background-color 0.3s, color 0.3s;
}

.tab-toggle .tab:last-child {
  border-right: none;
}

.tab-toggle input[type="radio"]:checked + .tab {
  background-color: #28a745; /* Green highlight */
  color: white;
  font-weight: bold;
}
  </style>
</head>

<body>
  <main class="page">
    <section class="card">
      <h2>Image Background Changer (MODNet)</h2>
      <p class="subtitle">
        Choose how to provide your portrait: upload an image or take a photo using your camera.
      </p>

      <!-- Upload Form -->
      <form id="uploadForm">

        <!-- Option to choose input source -->
        <div class="tab-toggle">
          <input type="radio" id="upload" name="inputOption" value="upload" checked>
          <label for="upload" class="tab">Upload Image</label>

          <input type="radio" id="camera" name="inputOption" value="camera">
          <label for="camera" class="tab">Take Photo</label>
        </div>

        <!-- Upload Image Section -->
        <div id="uploadSection">
          <label>
            Select Image File
            <input type="file" name="file" id="fileInput" accept="image/*">
          </label>
        </div>

        <!-- Camera Capture Section -->
        <div id="cameraSection" class="hidden">
          <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
            <button type="button" class="btn btn-secondary" id="toggleCameraBtn">üì∑ Start Camera</button>
            <div id="cameraContainer" class="hidden" style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:8px;">
              <video id="cameraPreview" autoplay playsinline width="320" height="240"></video>
              <div class="btn-bar">
                <button type="button" class="btn btn-primary" id="captureBtn">üì∏ Capture</button>
              </div>
              <canvas id="cameraCanvas" width="320" height="240"></canvas>
            </div>
          </div>
        </div>

        <!-- Mode Selection -->
        <label>
          Mode
          <select name="mode" id="modeSelect">
            <option value="color" selected>Solid color</option>
            <option value="custom">Custom background image</option>
            <option value="transparent">Remove background (PNG)</option>
          </select>
        </label>

        <!-- Color Picker -->
        <label id="colorField" style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          Choose Background Color
          <input type="color" name="color" id="colorPicker" value="#ffffff">
        </label>

        <!-- Custom Background Upload -->
        <label id="bgUploadField" style="display:none;flex-direction:column;align-items:flex-start;gap:6px;">
          Upload Background Image
          <input type="file" name="bg_file" id="bg_file" accept="image/*">
        </label>

        <!-- Submit Button -->
        <div class="btn-bar">
          <button class="btn btn-primary" type="submit">Change Background</button>
        </div>
      </form>

      <!-- Loading indicator -->
      <div id="loading" class="hidden">Processing... Please wait ‚è≥</div>

      <!-- Image Preview -->
      <div id="previewSection" class="image-grid hidden">
        <div class="image-box">
          <div class="image-label">Original</div>
          <img id="originalPreview" src="" alt="Original Image">
        </div>
        <div class="image-box">
          <div class="image-label">Result</div>
          <div class="checker">
            <img id="resultPreview" src="" alt="Changed Image">
          </div>
        </div>
      </div>

      <!-- Buttons below result -->
      <div id="buttons" class="btn-bar hidden">
        <a id="downloadLink" class="btn btn-success" href="#">‚¨á Download</a>
        <button class="btn btn-secondary" id="resetBtn" type="button">üîÑ Reset</button>
      </div>
    </section>
  </main>

  <!-- External JS -->
  <script src="/static/js/camera.js"></script>
  <script src="/static/js/image.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const inputOptions = document.querySelectorAll("input[name='inputOption']");
      const uploadSection = document.getElementById("uploadSection");
      const cameraSection = document.getElementById("cameraSection");

      const toggleCameraBtn = document.getElementById("toggleCameraBtn");
      const cameraContainer = document.getElementById("cameraContainer");
      const video = document.getElementById("cameraPreview");
      const canvas = document.getElementById("cameraCanvas");
      const captureBtn = document.getElementById("captureBtn");
      const fileInput = document.getElementById("fileInput");
      const originalPreview = document.getElementById("originalPreview");

      let camera;
      let cameraActive = false;

      // Toggle between upload and camera
      inputOptions.forEach(opt => {
        opt.addEventListener("change", () => {
          if (opt.value === "upload" && opt.checked) {
            uploadSection.classList.remove("hidden");
            cameraSection.classList.add("hidden");
          } else if (opt.value === "camera" && opt.checked) {
            uploadSection.classList.add("hidden");
            cameraSection.classList.remove("hidden");
          }
        });
      });

      // Single toggle button for camera start/stop
      toggleCameraBtn.addEventListener("click", async () => {
        if (!cameraActive) {
          cameraContainer.classList.remove("hidden");
          if (!camera) {
            const settings = new CameraSettings({ facing: "user", width: 640, height: 480 });
            camera = new CameraController(video, settings);
          }
          await camera.start();
          cameraActive = true;
          toggleCameraBtn.textContent = "‚ùå Stop Camera";
          toggleCameraBtn.style.background = "#dc3545"; // red
        } else {
          if (camera) await camera.stop();
          cameraContainer.classList.add("hidden");
          cameraActive = false;
          toggleCameraBtn.textContent = "üì∑ Start Camera";
          toggleCameraBtn.style.background = "#6c757d"; // grey
        }
      });

      // Capture button
      captureBtn.addEventListener("click", () => {
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob((blob) => {
          const file = new File([blob], "camera_capture.jpg", { type: "image/jpeg" });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          originalPreview.src = URL.createObjectURL(file);
          alert("‚úÖ Photo captured and ready to process!");
        }, "image/jpeg");
      });
    });
  </script>
</body>
</html>
