<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Background Changer (MODNet)</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .hidden { display: none; }
    video { border-radius: 6px; }
    canvas { display: none; }
    .btn-bar { display: flex; gap: 10px; margin-top: 10px; }
  </style>
</head>

<body>
  <main class="page">
    <section class="card">
      <h2>Image Background Changer (MODNet)</h2>
      <p class="subtitle">
        Upload your portrait or take a new photo, choose a background mode (color, custom, transparent), and view instantly.
      </p>

      <!-- Upload Form -->
      <form id="uploadForm">
        <!-- Portrait Upload -->
        <label>
          Upload Image
          <input type="file" name="file" id="fileInput" accept="image/*">
        </label>

        <!-- OR Take Photo Section -->
        <div id="cameraSection" style="margin-top:10px;">
          <button type="button" class="btn btn-secondary" id="openCameraBtn">üì∑ Take Photo</button>
          <div id="cameraContainer" class="hidden" style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:8px;">
            <video id="cameraPreview" autoplay playsinline width="320" height="240" style="border:1px solid #ccc;"></video>
            <div class="btn-bar">
              <button type="button" class="btn btn-primary" id="captureBtn">üì∏ Capture</button>
              <button type="button" class="btn btn-secondary" id="closeCameraBtn">‚ùå Close</button>
            </div>
            <canvas id="cameraCanvas" width="320" height="240"></canvas>
          </div>
        </div>

        <!-- Mode Selection -->
        <label>
          Mode
          <select name="mode" id="modeSelect">
            <option value="color" selected>Solid color</option>
            <option value="custom">Custom background image</option>
            <option value="transparent">Remove background (PNG)</option>
          </select>
        </label>

        <!-- Color Picker -->
        <label id="colorField" style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          Choose Background Color
          <input type="color" name="color" id="colorPicker" value="#ffffff">
        </label>

        <!-- Custom Background Upload -->
        <label id="bgUploadField" style="display:none;flex-direction:column;align-items:flex-start;gap:6px;">
          Upload Background Image
          <input type="file" name="bg_file" id="bg_file" accept="image/*">
        </label>

        <!-- Submit Button -->
        <div class="btn-bar">
          <button class="btn btn-primary" type="submit">Change Background</button>
        </div>
      </form>

      <!-- Loading indicator -->
      <div id="loading" class="hidden">Processing... Please wait ‚è≥</div>

      <!-- Image Preview -->
      <div id="previewSection" class="image-grid hidden">
        <div class="image-box">
          <div class="image-label">Original</div>
          <img id="originalPreview" src="" alt="Original Image">
        </div>
        <div class="image-box">
          <div class="image-label">Result</div>
          <div class="checker">
            <img id="resultPreview" src="" alt="Changed Image">
          </div>
        </div>
      </div>

      <!-- Buttons below result -->
      <div id="buttons" class="btn-bar hidden">
        <a id="downloadLink" class="btn btn-success" href="#">‚¨á Download</a>
        <button class="btn btn-secondary" id="resetBtn" type="button">üîÑ Reset</button>
      </div>
    </section>
  </main>

  <!-- External JS -->
  <script src="/static/js/camera.js"></script>
  <script src="/static/js/image.js"></script>

  <script>
    // Add camera integration logic
    document.addEventListener("DOMContentLoaded", () => {
      const openCameraBtn = document.getElementById("openCameraBtn");
      const cameraContainer = document.getElementById("cameraContainer");
      const video = document.getElementById("cameraPreview");
      const canvas = document.getElementById("cameraCanvas");
      const captureBtn = document.getElementById("captureBtn");
      const closeCameraBtn = document.getElementById("closeCameraBtn");
      const fileInput = document.getElementById("fileInput");
      const originalPreview = document.getElementById("originalPreview");

      let camera;

      openCameraBtn.addEventListener("click", async () => {
        cameraContainer.classList.remove("hidden");
        if (!camera) {
          const settings = new CameraSettings({ facing: "user", width: 640, height: 480 });
          camera = new CameraController(video, settings);
        }
        await camera.start();
      });

      closeCameraBtn.addEventListener("click", async () => {
        if (camera) await camera.stop();
        cameraContainer.classList.add("hidden");
      });

      captureBtn.addEventListener("click", () => {
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob((blob) => {
          const file = new File([blob], "camera_capture.jpg", { type: "image/jpeg" });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          // Preview captured image
          originalPreview.src = URL.createObjectURL(file);

          alert("‚úÖ Photo captured and ready to process!");
          camera.stop();
          cameraContainer.classList.add("hidden");
        }, "image/jpeg");
      });
    });
  </script>
</body>
</html>
